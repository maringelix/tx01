name: üóÑÔ∏è Configure Backup Automation

# This workflow configures AWS Backup automation with comprehensive IAM permissions
# 
# Features:
# - ‚úÖ Creates backup vault and backup plans
# - ‚úÖ Configures IAM role with proper permissions for ALL resource types
# - ‚úÖ Includes S3 backup permissions (EventBridge, CloudWatch, S3 operations)
# - ‚úÖ Tags resources automatically for backup selection
# - ‚úÖ Verifies IAM permissions before proceeding
# - ‚úÖ Supports cross-region backup replication
#
# Required Permissions (automatically configured):
# - AWS Backup managed policies (backup & restore)
# - S3: Full access for Terraform state bucket
# - EventBridge: Rule management for S3 backup notifications
# - CloudWatch: Metrics for backup monitoring
#
# Resources Protected:
# - RDS PostgreSQL databases
# - EBS volumes (EKS node storage)
# - S3 Terraform state bucket
# - DynamoDB state lock table

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to configure backups'
        required: true
        type: choice
        options:
          - stg
          - prd
        default: 'stg'
      backup_retention_days:
        description: 'Backup retention in days'
        required: true
        type: choice
        options:
          - '7'
          - '14'
          - '30'
          - '90'
        default: '7'
      enable_cross_region:
        description: 'Enable cross-region backup copy'
        required: true
        type: boolean
        default: false
      backup_schedule:
        description: 'Backup schedule (standard 5-field cron, UTC)'
        required: true
        type: string
        default: '0 3 * * *'  # 3 AM UTC daily (converted to AWS Backup format)

env:
  AWS_REGION: us-east-1
  BACKUP_REGION: us-west-2  # Cross-region backup destination

jobs:
  configure-aws-backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account: $ACCOUNT_ID"

      - name: Create backup vault
        run: |
          VAULT_NAME="tx01-backup-vault-${{ github.event.inputs.environment }}"
          
          # Check if vault exists
          if aws backup describe-backup-vault --backup-vault-name $VAULT_NAME 2>/dev/null; then
            echo "‚úÖ Backup vault already exists: $VAULT_NAME"
          else
            echo "Creating backup vault: $VAULT_NAME"
            aws backup create-backup-vault \
              --backup-vault-name $VAULT_NAME \
              --backup-vault-tags Project=tx01,Environment=${{ github.event.inputs.environment }},ManagedBy=github-actions
            echo "‚úÖ Backup vault created: $VAULT_NAME"
          fi

      - name: Create cross-region backup vault
        if: ${{ github.event.inputs.enable_cross_region == 'true' }}
        run: |
          VAULT_NAME="tx01-backup-vault-${{ github.event.inputs.environment }}-replica"
          
          # Check if vault exists in backup region
          if aws backup describe-backup-vault \
            --backup-vault-name $VAULT_NAME \
            --region ${{ env.BACKUP_REGION }} 2>/dev/null; then
            echo "‚úÖ Cross-region backup vault already exists: $VAULT_NAME"
          else
            echo "Creating cross-region backup vault: $VAULT_NAME"
            aws backup create-backup-vault \
              --backup-vault-name $VAULT_NAME \
              --region ${{ env.BACKUP_REGION }} \
              --backup-vault-tags Project=tx01,Environment=${{ github.event.inputs.environment }},ManagedBy=github-actions,VaultType=replica
            echo "‚úÖ Cross-region backup vault created: $VAULT_NAME"
          fi

      - name: Create IAM role for AWS Backup
        run: |
          ROLE_NAME="tx01-backup-role-${{ github.event.inputs.environment }}"
          
          # Check if role exists
          if aws iam get-role --role-name $ROLE_NAME 2>/dev/null; then
            echo "‚úÖ IAM role already exists: $ROLE_NAME"
          else
            echo "Creating IAM role for AWS Backup"
            
            # Create trust policy
            cat > /tmp/backup-trust-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "backup.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
          EOF
            
            # Create role
            aws iam create-role \
              --role-name $ROLE_NAME \
              --assume-role-policy-document file:///tmp/backup-trust-policy.json \
              --tags \
                Key=Project,Value=tx01 \
                Key=Environment,Value=${{ github.event.inputs.environment }}
            
            # Attach AWS managed policies
            aws iam attach-role-policy \
              --role-name $ROLE_NAME \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup
            
            aws iam attach-role-policy \
              --role-name $ROLE_NAME \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores
            
            echo "‚úÖ IAM role created: $ROLE_NAME"
          fi

      - name: Add S3 backup permissions to IAM role
        run: |
          ROLE_NAME="tx01-backup-role-${{ github.event.inputs.environment }}"
          
          echo "Adding comprehensive S3 backup permissions to role..."
          
          # Create S3 backup policy with all required permissions
          cat > /tmp/s3-backup-policy.json <<'EOF'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:GetBucketVersioning",
                  "s3:GetBucketLocation",
                  "s3:GetBucketTagging",
                  "s3:ListBucket",
                  "s3:GetBucketNotification",
                  "s3:PutBucketNotification",
                  "s3:GetBucketPolicy",
                  "s3:GetBucketPublicAccessBlock",
                  "s3:GetBucketAcl",
                  "s3:GetBucketLogging",
                  "s3:DescribeJob",
                  "s3:GetInventoryConfiguration",
                  "s3:PutInventoryConfiguration",
                  "s3:GetObject",
                  "s3:GetObjectVersion",
                  "s3:GetObjectVersionTagging",
                  "s3:GetObjectTagging",
                  "s3:GetObjectAcl",
                  "s3:PutObject"
                ],
                "Resource": [
                  "arn:aws:s3:::tx01-terraform-state-*",
                  "arn:aws:s3:::tx01-terraform-state-*/*"
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "events:ListRules",
                  "events:DescribeRule",
                  "events:PutRule",
                  "events:DeleteRule",
                  "events:PutTargets",
                  "events:RemoveTargets",
                  "events:ListTargetsByRule"
                ],
                "Resource": "*"
              },
              {
                "Effect": "Allow",
                "Action": [
                  "cloudwatch:GetMetricData",
                  "cloudwatch:GetMetricStatistics",
                  "cloudwatch:ListMetrics"
                ],
                "Resource": "*"
              }
            ]
          }
          EOF
          
          # Apply the policy (will overwrite if exists)
          aws iam put-role-policy \
            --role-name $ROLE_NAME \
            --policy-name S3BackupAccess \
            --policy-document file:///tmp/s3-backup-policy.json
          
          echo "‚úÖ S3 backup permissions added to role: $ROLE_NAME"

      - name: Verify IAM permissions
        run: |
          ROLE_NAME="tx01-backup-role-${{ github.event.inputs.environment }}"
          
          echo "============================================"
          echo "üîç Verifying IAM Role Permissions"
          echo "============================================"
          echo ""
          
          # Check attached managed policies
          echo "üìã Managed Policies:"
          aws iam list-attached-role-policies \
            --role-name $ROLE_NAME \
            --query 'AttachedPolicies[*].PolicyName' \
            --output text | tr '\t' '\n' | sed 's/^/  ‚úì /'
          
          echo ""
          echo "üìã Inline Policies:"
          aws iam list-role-policies \
            --role-name $ROLE_NAME \
            --query 'PolicyNames' \
            --output text | tr '\t' '\n' | sed 's/^/  ‚úì /'
          
          echo ""
          echo "‚úÖ IAM role permissions verified"

      - name: Create backup plan
        run: |
          PLAN_NAME="tx01-daily-backup-${{ github.event.inputs.environment }}"
          VAULT_NAME="tx01-backup-vault-${{ github.event.inputs.environment }}"
          ROLE_ARN="arn:aws:iam::${{ steps.account.outputs.account_id }}:role/tx01-backup-role-${{ github.event.inputs.environment }}"
          
          # Convert standard cron to AWS Backup cron format
          # AWS Backup requires 6 fields: minute hour day-of-month month day-of-week year
          # Use ? for day-of-month when running daily (to avoid conflict with day-of-week)
          SCHEDULE="${{ github.event.inputs.backup_schedule }}"
          AWS_SCHEDULE=$(echo "$SCHEDULE" | awk '{print $1, $2, "?", $4, $5, "*"}')
          echo "Schedule: cron($AWS_SCHEDULE)"
          
          # Create backup plan JSON
          cat > /tmp/backup-plan.json <<EOF
          {
            "BackupPlanName": "$PLAN_NAME",
            "Rules": [
              {
                "RuleName": "DailyBackup",
                "TargetBackupVaultName": "$VAULT_NAME",
                "ScheduleExpression": "cron($AWS_SCHEDULE)",
                "StartWindowMinutes": 60,
                "CompletionWindowMinutes": 120,
                "Lifecycle": {
                  "DeleteAfterDays": ${{ github.event.inputs.backup_retention_days }}
                },
                "RecoveryPointTags": {
                  "Project": "tx01",
                  "Environment": "${{ github.event.inputs.environment }}",
                  "BackupType": "automated"
                }
              }
            ]
          }
          EOF
          
          # Check if plan exists
          EXISTING_PLAN=$(aws backup list-backup-plans \
            --query "BackupPlansList[?BackupPlanName=='$PLAN_NAME'].BackupPlanId" \
            --output text)
          
          if [ -z "$EXISTING_PLAN" ]; then
            echo "Creating backup plan: $PLAN_NAME"
            PLAN_ID=$(aws backup create-backup-plan \
              --backup-plan file:///tmp/backup-plan.json \
              --query 'BackupPlanId' \
              --output text)
            echo "‚úÖ Backup plan created: $PLAN_ID"
          else
            echo "Updating existing backup plan: $EXISTING_PLAN"
            aws backup update-backup-plan \
              --backup-plan-id $EXISTING_PLAN \
              --backup-plan file:///tmp/backup-plan.json
            PLAN_ID=$EXISTING_PLAN
            echo "‚úÖ Backup plan updated: $PLAN_ID"
          fi
          
          echo "BACKUP_PLAN_ID=$PLAN_ID" >> $GITHUB_ENV

      - name: Add backup selection for RDS
        run: |
          PLAN_NAME="tx01-daily-backup-${{ github.event.inputs.environment }}"
          ROLE_ARN="arn:aws:iam::${{ steps.account.outputs.account_id }}:role/tx01-backup-role-${{ github.event.inputs.environment }}"
          
          # Get backup plan ID
          PLAN_ID=$(aws backup list-backup-plans \
            --query "BackupPlansList[?BackupPlanName=='$PLAN_NAME'].BackupPlanId" \
            --output text)
          
          # Create selection JSON for RDS
          cat > /tmp/backup-selection-rds.json <<EOF
          {
            "SelectionName": "tx01-rds-${{ github.event.inputs.environment }}",
            "IamRoleArn": "$ROLE_ARN",
            "Resources": [],
            "ListOfTags": [
              {
                "ConditionType": "STRINGEQUALS",
                "ConditionKey": "Project",
                "ConditionValue": "tx01"
              },
              {
                "ConditionType": "STRINGEQUALS",
                "ConditionKey": "Environment",
                "ConditionValue": "${{ github.event.inputs.environment }}"
              }
            ],
            "Conditions": {
              "StringEquals": [
                {
                  "ConditionKey": "aws:ResourceTag/BackupEnabled",
                  "ConditionValue": "true"
                }
              ]
            }
          }
          EOF
          
          # Try to create selection (will fail if exists, that's ok)
          aws backup create-backup-selection \
            --backup-plan-id $PLAN_ID \
            --backup-selection file:///tmp/backup-selection-rds.json 2>/dev/null || \
            echo "‚úÖ Backup selection already exists or updated"

      - name: Add backup selection for EBS volumes
        run: |
          PLAN_NAME="tx01-daily-backup-${{ github.event.inputs.environment }}"
          ROLE_ARN="arn:aws:iam::${{ steps.account.outputs.account_id }}:role/tx01-backup-role-${{ github.event.inputs.environment }}"
          
          # Get backup plan ID
          PLAN_ID=$(aws backup list-backup-plans \
            --query "BackupPlansList[?BackupPlanName=='$PLAN_NAME'].BackupPlanId" \
            --output text)
          
          # Create selection JSON for EBS
          cat > /tmp/backup-selection-ebs.json <<EOF
          {
            "SelectionName": "tx01-ebs-${{ github.event.inputs.environment }}",
            "IamRoleArn": "$ROLE_ARN",
            "Resources": [],
            "ListOfTags": [
              {
                "ConditionType": "STRINGEQUALS",
                "ConditionKey": "Project",
                "ConditionValue": "tx01"
              },
              {
                "ConditionType": "STRINGEQUALS",
                "ConditionKey": "Environment",
                "ConditionValue": "${{ github.event.inputs.environment }}"
              },
              {
                "ConditionType": "STRINGEQUALS",
                "ConditionKey": "BackupEnabled",
                "ConditionValue": "true"
              }
            ]
          }
          EOF
          
          # Try to create selection
          aws backup create-backup-selection \
            --backup-plan-id $PLAN_ID \
            --backup-selection file:///tmp/backup-selection-ebs.json 2>/dev/null || \
            echo "‚úÖ Backup selection already exists or updated"

      - name: Tag RDS instances for backup
        run: |
          # Find RDS instances (tx01-db-stg or tx01-rds-stg)
          RDS_INSTANCES=$(aws rds describe-db-instances \
            --query "DBInstances[?contains(DBInstanceIdentifier, 'tx01-') && contains(DBInstanceIdentifier, '-${{ github.event.inputs.environment }}')].DBInstanceArn" \
            --output text)
          
          if [ -n "$RDS_INSTANCES" ]; then
            for RDS_ARN in $RDS_INSTANCES; do
              echo "Tagging RDS: $RDS_ARN"
              aws rds add-tags-to-resource \
                --resource-name $RDS_ARN \
                --tags \
                  Key=BackupEnabled,Value=true \
                  Key=BackupRetention,Value=${{ github.event.inputs.backup_retention_days }}
              echo "‚úÖ Tagged: $RDS_ARN"
            done
          else
            echo "‚ö†Ô∏è No RDS instances found for tx01-${{ github.event.inputs.environment }}"
          fi

      - name: Tag EBS volumes for backup
        run: |
          # Find EBS volumes attached to EKS nodes
          CLUSTER_NAME="tx01-eks-${{ github.event.inputs.environment }}"
          
          # Get EBS volumes from EKS cluster
          VOLUME_IDS=$(aws ec2 describe-volumes \
            --filters \
              "Name=tag:kubernetes.io/cluster/$CLUSTER_NAME,Values=owned" \
            --query "Volumes[].VolumeId" \
            --output text)
          
          if [ -n "$VOLUME_IDS" ]; then
            for VOLUME_ID in $VOLUME_IDS; do
              echo "Tagging EBS volume: $VOLUME_ID"
              aws ec2 create-tags \
                --resources $VOLUME_ID \
                --tags \
                  Key=BackupEnabled,Value=true \
                  Key=BackupRetention,Value=${{ github.event.inputs.backup_retention_days }} \
                  Key=Project,Value=tx01 \
                  Key=Environment,Value=${{ github.event.inputs.environment }}
              echo "‚úÖ Tagged: $VOLUME_ID"
            done
          else
            echo "‚ö†Ô∏è No EBS volumes found for cluster $CLUSTER_NAME"
          fi

      - name: Configure S3 Terraform State bucket for backup
        run: |
          BUCKET_NAME="tx01-terraform-state-maringelix-2025"
          
          echo "Configuring S3 bucket for backup: $BUCKET_NAME"
          
          # Check if bucket exists
          if aws s3api head-bucket --bucket $BUCKET_NAME 2>/dev/null; then
            echo "‚úÖ S3 bucket found: $BUCKET_NAME"
            
            # Update tags to include Environment=stg for backup selection
            echo "Updating bucket tags..."
            aws s3api put-bucket-tagging \
              --bucket $BUCKET_NAME \
              --tagging "TagSet=[
                {Key=Project,Value=tx01},
                {Key=Environment,Value=${{ github.event.inputs.environment }}},
                {Key=ManagedBy,Value=Terraform},
                {Key=Name,Value=$BUCKET_NAME},
                {Key=BackupEnabled,Value=true}
              ]"
            
            echo "‚úÖ S3 bucket tags updated for backup selection"
          else
            echo "‚ö†Ô∏è S3 Terraform state bucket not found: $BUCKET_NAME"
            echo "   Bucket will be tagged when created via terraform-bootstrap workflow"
          fi

      - name: Configure DynamoDB table for backup
        run: |
          TABLE_NAME="tx01-terraform-state-maringelix-2025-locks"
          
          echo "Configuring DynamoDB table for backup: $TABLE_NAME"
          
          # Check if table exists
          if aws dynamodb describe-table --table-name $TABLE_NAME 2>/dev/null; then
            echo "‚úÖ DynamoDB table found: $TABLE_NAME"
            
            # Tag the table for backup
            TABLE_ARN=$(aws dynamodb describe-table \
              --table-name $TABLE_NAME \
              --query 'Table.TableArn' \
              --output text)
            
            echo "Updating table tags..."
            aws dynamodb tag-resource \
              --resource-arn $TABLE_ARN \
              --tags \
                Key=Project,Value=tx01 \
                Key=Environment,Value=${{ github.event.inputs.environment }} \
                Key=BackupEnabled,Value=true
            
            echo "‚úÖ DynamoDB table tags updated for backup"
          else
            echo "‚ö†Ô∏è DynamoDB table not found: $TABLE_NAME"
            echo "   Table will be tagged when created via terraform-bootstrap workflow"
          fi

      - name: Verify RDS backup configuration
        run: |
          # Find RDS instances (tx01-db-stg or tx01-rds-stg)
          RDS_INSTANCES=$(aws rds describe-db-instances \
            --query "DBInstances[?contains(DBInstanceIdentifier, 'tx01-') && contains(DBInstanceIdentifier, '-${{ github.event.inputs.environment }}')].DBInstanceIdentifier" \
            --output text)
          
          if [ -n "$RDS_INSTANCES" ]; then
            for RDS_ID in $RDS_INSTANCES; do
              echo "Checking backup configuration for: $RDS_ID"
              RETENTION=$(aws rds describe-db-instances \
                --db-instance-identifier $RDS_ID \
                --query "DBInstances[0].BackupRetentionPeriod" \
                --output text)
              echo "‚úÖ Current retention period: $RETENTION days (AWS Backup will manage additional backups)"
            done
          else
            echo "‚ö†Ô∏è No RDS instances found"
          fi

      - name: Configure cross-region copy
        if: ${{ github.event.inputs.enable_cross_region == 'true' }}
        run: |
          PLAN_NAME="tx01-daily-backup-${{ github.event.inputs.environment }}"
          VAULT_NAME="tx01-backup-vault-${{ github.event.inputs.environment }}-replica"
          
          # Get backup plan ID
          PLAN_ID=$(aws backup list-backup-plans \
            --query "BackupPlansList[?BackupPlanName=='$PLAN_NAME'].BackupPlanId" \
            --output text)
          
          # Update plan with copy action
          cat > /tmp/backup-plan-cross-region.json <<EOF
          {
            "BackupPlanName": "$PLAN_NAME",
            "Rules": [
              {
                "RuleName": "DailyBackup",
                "TargetBackupVaultName": "tx01-backup-vault-${{ github.event.inputs.environment }}",
                "ScheduleExpression": "cron(${{ github.event.inputs.backup_schedule }})",
                "StartWindowMinutes": 60,
                "CompletionWindowMinutes": 120,
                "Lifecycle": {
                  "DeleteAfterDays": ${{ github.event.inputs.backup_retention_days }}
                },
                "CopyActions": [
                  {
                    "DestinationBackupVaultArn": "arn:aws:backup:${{ env.BACKUP_REGION }}:${{ steps.account.outputs.account_id }}:backup-vault:$VAULT_NAME",
                    "Lifecycle": {
                      "DeleteAfterDays": ${{ github.event.inputs.backup_retention_days }}
                    }
                  }
                ],
                "RecoveryPointTags": {
                  "Project": "tx01",
                  "Environment": "${{ github.event.inputs.environment }}",
                  "BackupType": "automated"
                }
              }
            ]
          }
          EOF
          
          echo "Updating backup plan with cross-region copy"
          aws backup update-backup-plan \
            --backup-plan-id $PLAN_ID \
            --backup-plan file:///tmp/backup-plan-cross-region.json
          echo "‚úÖ Cross-region copy configured"

      - name: Display backup configuration summary
        run: |
          echo "============================================"
          echo "üóÑÔ∏è Backup Configuration Summary"
          echo "============================================"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Retention: ${{ github.event.inputs.backup_retention_days }} days"
          echo "Schedule: ${{ github.event.inputs.backup_schedule }} (UTC)"
          echo "Cross-region: ${{ github.event.inputs.enable_cross_region }}"
          echo ""
          echo "üì¶ Resources protected:"
          echo "  - RDS PostgreSQL databases"
          echo "  - EBS volumes (EKS persistent storage)"
          echo "  - Automated daily snapshots"
          echo ""
          echo "üîí Backup vault: tx01-backup-vault-${{ github.event.inputs.environment }}"
          echo "üìç Primary region: ${{ env.AWS_REGION }}"
          if [ "${{ github.event.inputs.enable_cross_region }}" = "true" ]; then
            echo "üìç Backup region: ${{ env.BACKUP_REGION }}"
          fi
          echo ""
          echo "‚úÖ Backup automation configured successfully!"
          echo ""
          echo "üí° Next steps:"
          echo "  1. Verify backups in AWS Console: AWS Backup > Backup vaults"
          echo "  2. Wait for first backup (scheduled at ${{ github.event.inputs.backup_schedule }} UTC)"
          echo "  3. Test restore using the 'Restore from Backup' workflow"
          echo ""

      - name: Send Slack notification
        if: always()
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            COLOR="good"
            EMOJI="‚úÖ"
            STATUS="SUCCESS"
          else
            COLOR="danger"
            EMOJI="‚ùå"
            STATUS="FAILED"
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Backup Configuration $STATUS\",
                \"text\": \"Environment: ${{ github.event.inputs.environment }}\nRetention: ${{ github.event.inputs.backup_retention_days }} days\nCross-region: ${{ github.event.inputs.enable_cross_region }}\",
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }"
