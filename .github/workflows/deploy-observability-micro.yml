name: ๐ Deploy Observability Stack (MICRO - Free Tier Optimized)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall
          - upgrade

env:
  AWS_REGION: us-east-1

jobs:
  deploy-observability-micro:
    name: ๐ ${{ github.event.inputs.action }} Observability Stack (MICRO)
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
      
      - name: ๐ง Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: โธ๏ธ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
          
          echo "โ Kubectl configured"
          kubectl cluster-info
      
      - name: ๐ Pre-flight Check & Auto-Scale
        run: |
          echo "๐ Checking cluster capacity..."
          echo ""
          
          NODE_COUNT=$(kubectl get nodes --no-headers 2>/dev/null | grep -c "Ready" || echo 0)
          READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c " Ready " || echo 0)
          TOTAL_PODS=$(kubectl get pods -A --no-headers --field-selector=status.phase!=Succeeded,status.phase!=Failed 2>/dev/null | wc -l)
          POD_CAPACITY=$((READY_NODES * 4))
          FREE_SLOTS=$((POD_CAPACITY - TOTAL_PODS))
          
          echo "๐ Cluster Status:"
          echo "   Nodes Ready: $READY_NODES/$NODE_COUNT"
          echo "   Total pods (Running+Pending): $TOTAL_PODS"
          echo "   Pod capacity: $POD_CAPACITY"
          echo "   Free slots: $FREE_SLOTS"
          echo ""
          
          # Clean up any orphaned LoadBalancer services first
          echo "๐งน Cleaning up LoadBalancer services..."
          kubectl get svc -n monitoring -o json 2>/dev/null | \
            jq -r '.items[] | select(.spec.type=="LoadBalancer") | .metadata.name' | \
            xargs -r -I {} kubectl delete svc -n monitoring {} --ignore-not-found=true || echo "No LoadBalancer services found"
          
          if [ $FREE_SLOTS -lt 4 ]; then
            echo "โ๏ธ  Not enough capacity - Auto-scaling to 12 nodes (for buffer)..."
            
            aws eks update-nodegroup-config \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
              --scaling-config desiredSize=12,minSize=4,maxSize=15 \
              --region ${{ env.AWS_REGION }}
            
            echo "โณ Waiting for nodes to be Ready (max 5 minutes)..."
            for i in {1..20}; do
              sleep 15
              READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c " Ready " || echo 0)
              echo "   Attempt $i/20: $READY_NODES Ready nodes"
              
              TOTAL_PODS=$(kubectl get pods -A --no-headers --field-selector=status.phase!=Succeeded,status.phase!=Failed 2>/dev/null | wc -l)
              POD_CAPACITY=$((READY_NODES * 4))
              FREE_SLOTS=$((POD_CAPACITY - TOTAL_PODS))
              
              if [ $FREE_SLOTS -ge 4 ]; then
                echo "โ Sufficient capacity now available!"
                echo "   Free slots: $FREE_SLOTS"
                break
              fi
              
              if [ $i -eq 20 ]; then
                echo "โ Timeout waiting for capacity"
                echo "   Current: $FREE_SLOTS free slots (need 4)"
                exit 1
              fi
            done
          else
            echo "โ Sufficient capacity available"
          fi
          
          echo ""
          echo "๐ฏ Ready to install observability stack"
          echo "   Will deploy: Prometheus, Grafana, Kube State Metrics, Operator"
          echo ""
      
      - name: ๐ฏ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: ๐ฆ Add Helm Repositories
        run: |
          echo "๐ฆ Adding Helm repositories..."
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          echo "โ Repositories added and updated"
      
      - name: ๐ Create Monitoring Namespace
        if: github.event.inputs.action == 'install'
        run: |
          echo "๐ Creating monitoring namespace..."
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          echo "โ Namespace ready"
      
      - name: ๐ Validate Grafana Password Secret
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "๐ Validating GRAFANA_PASSWORD secret..."
          
          if [ -z "${{ secrets.GRAFANA_PASSWORD }}" ]; then
            echo "โ ERROR: GRAFANA_PASSWORD secret is not configured!"
            echo ""
            echo "๐ To configure it:"
            echo "   1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: GRAFANA_PASSWORD"
            echo "   4. Value: <your-strong-password>"
            echo ""
            echo "โ๏ธ  Use a strong password for production environments!"
            exit 1
          fi
          
          PASSWORD_LENGTH=$(echo -n "${{ secrets.GRAFANA_PASSWORD }}" | wc -c)
          if [ $PASSWORD_LENGTH -lt 8 ]; then
            echo "โ๏ธ  WARNING: Password is too short (less than 8 characters)"
            echo "๐ Consider using a stronger password for production"
          fi
          
          echo "โ GRAFANA_PASSWORD secret is configured (length: $PASSWORD_LENGTH chars)"
          echo "๐ Password will be securely applied to Grafana deployment"
      
      - name: ๐ Ensure EBS CSI Driver is installed
        if: github.event.inputs.action == 'install'
        run: |
          echo "๐ Checking EBS CSI Driver addon..."
          
          ADDON_STATUS=$(aws eks describe-addon \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --addon-name aws-ebs-csi-driver \
            --region ${{ env.AWS_REGION }} \
            --query 'addon.status' \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$ADDON_STATUS" = "NOT_FOUND" ]; then
            echo "โ๏ธ  EBS CSI Driver not found, installing..."
            
            # Check if IAM role exists
            ROLE_EXISTS=$(aws iam get-role \
              --role-name tx01-eks-ebs-csi-driver \
              --query 'Role.RoleName' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$ROLE_EXISTS" = "NOT_FOUND" ]; then
              echo "Creating IAM role for EBS CSI Driver..."
              
              # Get OIDC provider
              OIDC_ID=$(aws eks describe-cluster \
                --name tx01-eks-${{ github.event.inputs.environment }} \
                --region ${{ env.AWS_REGION }} \
                --query 'cluster.identity.oidc.issuer' \
                --output text | cut -d '/' -f 5)
              
              ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
              
              # Create trust policy
              cat > trust-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": {
                "Federated": "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}"
              },
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                "StringEquals": {
                  "oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}:aud": "sts.amazonaws.com",
                  "oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                }
              }
            }]
          }
          EOF
              
              # Create role
              aws iam create-role \
                --role-name tx01-eks-ebs-csi-driver \
                --assume-role-policy-document file://trust-policy.json
              
              # Attach policy
              aws iam attach-role-policy \
                --role-name tx01-eks-ebs-csi-driver \
                --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
              
              echo "โ IAM role created"
            else
              echo "โ IAM role already exists"
            fi
            
            # Install addon
            aws eks create-addon \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/tx01-eks-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            
            echo "โณ Waiting for addon to be ACTIVE..."
            aws eks wait addon-active \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            
            echo "โ EBS CSI Driver installed"
          elif [ "$ADDON_STATUS" = "ACTIVE" ]; then
            echo "โ EBS CSI Driver already active"
          else
            echo "โ๏ธ  EBS CSI Driver status: $ADDON_STATUS"
            echo "Waiting for it to become ACTIVE..."
            aws eks wait addon-active \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            echo "โ EBS CSI Driver is now active"
          fi
      
      - name: ๐ Install Prometheus + Grafana (MICRO Stack)
        if: github.event.inputs.action == 'install'
        run: |
          echo "๐ Installing kube-prometheus-stack (MICRO version)..."
          echo ""
          echo "๐ฏ MICRO Stack Components:"
          echo "   โ Prometheus Server (1 pod, 2Gi storage)"
          echo "   โ Grafana (1 pod, 2Gi storage)"
          echo "   โ Kube State Metrics (1 pod)"
          echo "   โ AlertManager (disabled)"
          echo "   โ Node Exporter (disabled - saves 4 DaemonSet pods)"
          echo "   โ Prometheus Operator CRDs (minimal)"
          echo ""
          echo "๐ก For logs, use AWS CloudWatch (Free Tier: 5GB/month)"
          echo ""
          
          # Increase kubectl timeout
          export KUBECTL_TIMEOUT=120s
          
          # Verify cluster connectivity with retry
          echo "๐ Verifying cluster connectivity..."
          for i in {1..3}; do
            if kubectl cluster-info --request-timeout=30s; then
              echo "โ Cluster is reachable"
              break
            else
              echo "โ๏ธ  Attempt $i/3 failed, retrying in 10s..."
              sleep 10
            fi
          done
          
          helm upgrade --install kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --create-namespace \
            --values k8s/prometheus-micro-values.yaml \
            --set grafana.adminPassword=${{ secrets.GRAFANA_PASSWORD }} \
            --set prometheus-node-exporter.enabled=false \
            --set nodeExporter.enabled=false \
            --timeout=20m \
            --wait
          
          echo ""
          echo "โ Prometheus + Grafana (MICRO) installed"
      
      - name: ๐ Upgrade Stack
        if: github.event.inputs.action == 'upgrade'
        run: |
          echo "๐ Upgrading observability stack (MICRO)..."
          echo ""
          echo "๐งน Cleaning LoadBalancer service first..."
          kubectl delete svc -n monitoring kube-prometheus-stack-grafana --ignore-not-found=true
          echo ""
          
          helm upgrade kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --values k8s/prometheus-micro-values.yaml \
            --set grafana.adminPassword=${{ secrets.GRAFANA_PASSWORD }} \
            --set prometheus-node-exporter.enabled=false \
            --set nodeExporter.enabled=false \
            --wait --timeout=15m
          
          echo ""
          echo "โ Stack upgraded with ClusterIP service"
          echo "๐ก Access Grafana: kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80"
      
      - name: ๐๏ธ Uninstall Stack
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "๐๏ธ Uninstalling observability stack (MICRO)..."
          
          helm uninstall kube-prometheus-stack -n monitoring || echo "Already uninstalled"
          
          echo "โ๏ธ  Namespace 'monitoring' preserved (contains PVCs)"
          echo "To fully remove: kubectl delete namespace monitoring --grace-period=0 --force"
          
          echo "โ Stack uninstalled"
      
      - name: โณ Wait for Pods
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "โณ Waiting for pods to be ready..."
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=prometheus \
            -n monitoring \
            --timeout=300s || echo "Prometheus pods not ready yet (may still be starting)"
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=grafana \
            -n monitoring \
            --timeout=300s || echo "Grafana pods not ready yet (may still be starting)"
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=kube-state-metrics \
            -n monitoring \
            --timeout=300s || echo "Kube State Metrics not ready yet (may still be starting)"
          
          echo "โ Pods are ready"
      
      - name: ๐ Get Grafana URL
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        id: grafana-url
        run: |
          echo "๐ Getting Grafana URL..."
          
          # Wait for LoadBalancer to be ready
          sleep 30
          
          GRAFANA_URL=$(kubectl get svc -n monitoring kube-prometheus-stack-grafana \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
          
          if [ "$GRAFANA_URL" = "pending" ] || [ -z "$GRAFANA_URL" ]; then
            echo "โณ LoadBalancer is still provisioning..."
            echo "   Run this command later to get the URL:"
            echo "   kubectl get svc -n monitoring kube-prometheus-stack-grafana"
          else
            echo "grafana_url=$GRAFANA_URL" >> $GITHUB_OUTPUT
            echo "โ Grafana URL: http://$GRAFANA_URL"
          fi
      
      - name: ๐ Show Final Status
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ OBSERVABILITY STACK (MICRO) - DEPLOYMENT COMPLETE"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          
          echo "๐ฆ Installed Components:"
          kubectl get pods -n monitoring -o wide
          echo ""
          
          echo "๐พ Storage:"
          kubectl get pvc -n monitoring
          echo ""
          
          echo "๐ Services:"
          kubectl get svc -n monitoring
          echo ""
          
          GRAFANA_URL=$(kubectl get svc -n monitoring kube-prometheus-stack-grafana \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
          
          TOTAL_PODS=$(kubectl get pods -A --no-headers | wc -l)
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          POD_CAPACITY=$((NODE_COUNT * 4))
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ CLUSTER STATUS"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "   Nodes: $NODE_COUNT"
          echo "   Pods: $TOTAL_PODS / $POD_CAPACITY"
          echo "   Free slots: $((POD_CAPACITY - TOTAL_PODS))"
          echo ""
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฏ ACCESS GRAFANA"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          
          if [ "$GRAFANA_URL" != "pending" ] && [ -n "$GRAFANA_URL" ]; then
            echo "   ๐ URL: http://$GRAFANA_URL"
            echo "   ๐ค User: admin"
            echo "   ๐ Password: (from GRAFANA_PASSWORD secret)"
            echo ""
            echo "   โณ Wait 2-3 minutes for DNS propagation"
          else
            echo "   โณ LoadBalancer still provisioning..."
            echo "   Get URL with: kubectl get svc -n monitoring kube-prometheus-stack-grafana"
          fi
          echo ""
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ก MICRO STACK LIMITATIONS"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "   โ AlertManager disabled (use CloudWatch Alarms)"
          echo "   โ Node Exporter disabled (basic node metrics only)"
          echo "   โ Loki disabled (use CloudWatch Logs - 5GB/month free)"
          echo "   โ Prometheus metrics: 3 days retention"
          echo "   โ Grafana dashboards: Full functionality"
          echo "   โ Resource usage: ~530MB total"
          echo ""
          echo "   ๐ For full stack: Use deploy-observability.yml (requires t3.small+)"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
