name: ğŸ›¡ï¸ Deploy OPA Gatekeeper

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - upgrade
          - uninstall
      enforcement_mode:
        description: 'Enforcement Mode'
        required: false
        type: choice
        default: 'dryrun'
        options:
          - dryrun
          - enforce

env:
  AWS_REGION: us-east-1
  GATEKEEPER_VERSION: v3.15.0

jobs:
  deploy-gatekeeper:
    name: ğŸ›¡ï¸ ${{ github.event.inputs.action }} OPA Gatekeeper
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Kubectl configured"
          kubectl cluster-info
      
      - name: ğŸ¯ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: ğŸ“¦ Add Gatekeeper Helm Repository
        run: |
          echo "ğŸ“¦ Adding Gatekeeper Helm repository..."
          helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
          helm repo update
          echo "âœ… Repository added"
      
      - name: ğŸ“ Create Gatekeeper Namespace
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“ Creating gatekeeper-system namespace..."
          kubectl create namespace gatekeeper-system --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ready"
      
      - name: ğŸ” Pre-install Debug
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ” Checking cluster resources before install..."
          echo ""
          echo "ğŸ“Š Node status:"
          kubectl get nodes -o wide
          echo ""
          echo "ğŸ’¾ Node resources:"
          kubectl top nodes || echo "âš ï¸ Metrics server not available"
          echo ""
          echo "ğŸ“¦ Existing pods in gatekeeper-system:"
          kubectl get pods -n gatekeeper-system || echo "No existing pods"
          echo ""
          echo "ğŸ”§ Checking for existing Helm release:"
          helm list -n gatekeeper-system || echo "No existing release"
      
      - name: ğŸ›¡ï¸ Install OPA Gatekeeper
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ›¡ï¸ Installing OPA Gatekeeper..."
          echo "â° Timeout: 10m"
          echo "ğŸ”¢ Replicas: 1"
          echo ""
          
          # Install with debug output
          helm upgrade --install gatekeeper gatekeeper/gatekeeper \
            --namespace gatekeeper-system \
            --set enableExternalData=false \
            --set auditInterval=60 \
            --set constraintViolationsLimit=100 \
            --set auditFromCache=true \
            --set replicas=1 \
            --set revisionHistoryLimit=5 \
            --set enableGeneratorResourceExpansion=true \
            --set metrics.enabled=true \
            --set metrics.prometheusEnabled=true \
            --debug \
            --wait --timeout=10m
          
          echo ""
          echo "âœ… Helm install command completed"
          echo ""
          echo "ğŸ“Š Checking pod status..."
          kubectl get pods -n gatekeeper-system -o wide
          echo ""
          echo "ğŸ“‹ Pod details:"
          kubectl describe pods -n gatekeeper-system | head -n 50
          echo ""
          echo "ğŸ” Recent events:"
          kubectl get events -n gatekeeper-system --sort-by='.lastTimestamp' | tail -n 20
      
      - name: â³ Wait for Gatekeeper to be Ready
        if: github.event.inputs.action == 'install'
        run: |
          echo "â³ Waiting for Gatekeeper webhooks to be ready..."
          sleep 30
          
          kubectl wait --for=condition=Available \
            deployment/gatekeeper-controller-manager \
            -n gatekeeper-system \
            --timeout=300s
          
          kubectl wait --for=condition=Available \
            deployment/gatekeeper-audit \
            -n gatekeeper-system \
            --timeout=300s
          
          echo "âœ… Gatekeeper is ready"
      
      - name: ğŸ“Š Create ServiceMonitor for Prometheus
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“Š Creating ServiceMonitor for Prometheus integration..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: gatekeeper-controller-manager-metrics
            namespace: gatekeeper-system
            labels:
              app: gatekeeper
              release: kube-prometheus-stack
          spec:
            ports:
            - name: metrics
              port: 8888
              protocol: TCP
              targetPort: 8888
            selector:
              control-plane: controller-manager
              gatekeeper.sh/operation: webhook
          ---
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: gatekeeper-controller-manager
            namespace: gatekeeper-system
            labels:
              app: gatekeeper
              release: kube-prometheus-stack
          spec:
            selector:
              matchLabels:
                app: gatekeeper
            endpoints:
            - port: metrics
              interval: 30s
              path: /metrics
          EOF
          
          echo "âœ… ServiceMonitor created - Prometheus will scrape Gatekeeper metrics"
      
      - name: ğŸ“‹ Apply Policy Templates
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“‹ Applying OPA policy templates..."
          
          if [ -d "k8s/policies/templates" ]; then
            kubectl apply -f k8s/policies/templates/
            echo "âœ… Policy templates applied"
          else
            echo "âš ï¸ No templates found in k8s/policies/templates/"
          fi
      
      - name: ğŸ”’ Apply Constraints (${{ github.event.inputs.enforcement_mode }} mode)
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ”’ Applying constraints in ${{ github.event.inputs.enforcement_mode }} mode..."
          
          CONSTRAINTS_DIR="k8s/policies/constraints/${{ github.event.inputs.enforcement_mode }}"
          
          if [ -d "$CONSTRAINTS_DIR" ]; then
            # Replace enforcement mode in constraints
            for file in $CONSTRAINTS_DIR/*.yaml; do
              if [ -f "$file" ]; then
                sed "s/ENFORCEMENT_MODE/${{ github.event.inputs.enforcement_mode }}/g" "$file" | kubectl apply -f -
              fi
            done
            echo "âœ… Constraints applied in ${{ github.event.inputs.enforcement_mode }} mode"
          else
            echo "âš ï¸ No constraints found in $CONSTRAINTS_DIR"
          fi
      
      - name: ğŸ”„ Upgrade Gatekeeper
        if: github.event.inputs.action == 'upgrade'
        run: |
          echo "ğŸ”„ Upgrading OPA Gatekeeper..."
          
          helm upgrade gatekeeper gatekeeper/gatekeeper \
            --namespace gatekeeper-system \
            --reuse-values \
            --wait --timeout=5m
          
          echo "âœ… Gatekeeper upgraded"
      
      - name: ğŸ—‘ï¸ Uninstall Gatekeeper
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "ğŸ—‘ï¸ Removing constraints first..."
          kubectl delete constraints --all -A || echo "No constraints to delete"
          
          echo "ğŸ—‘ï¸ Removing constraint templates..."
          kubectl delete constrainttemplates --all || echo "No templates to delete"
          
          echo "ğŸ—‘ï¸ Uninstalling Gatekeeper..."
          helm uninstall gatekeeper -n gatekeeper-system || echo "Already uninstalled"
          
          echo "âš ï¸ Namespace 'gatekeeper-system' preserved"
          echo "To fully remove: kubectl delete namespace gatekeeper-system"
          
          echo "âœ… Gatekeeper uninstalled"
      
      - name: ğŸ“Š Show Status
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸  OPA GATEKEEPER STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          echo "ğŸ“¦ Pods:"
          kubectl get pods -n gatekeeper-system
          echo ""
          
          echo "ğŸ“‹ Constraint Templates:"
          kubectl get constrainttemplates
          echo ""
          
          echo "ğŸ”’ Constraints:"
          kubectl get constraints --all-namespaces
          echo ""
          
          echo "ğŸ“Š Policy Violations (last 10):"
          kubectl get constraints -A -o json | \
            jq -r '.items[] | select(.status.totalViolations > 0) | 
              "âŒ \(.metadata.name): \(.status.totalViolations) violations"' | \
            head -n 10 || echo "No violations found"
          echo ""
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Gatekeeper is running in ${{ github.event.inputs.enforcement_mode }} mode"
          echo ""
          echo "ğŸ“Š View metrics in Grafana:"
          echo "   â€¢ Prometheus target: gatekeeper-controller-manager-metrics:8888"
          echo "   â€¢ Metrics available: gatekeeper_violations, gatekeeper_constraint_templates"
          echo ""
          echo "ğŸ” Check violations:"
          echo "   kubectl get constraints -A"
          echo ""
          echo "ğŸ’¡ To test policies:"
          echo "   kubectl apply -f k8s/test-policy-violation.yaml"
