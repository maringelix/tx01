name: ðŸ”§ Terraform Import EBS CSI Driver

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd

env:
  AWS_REGION: us-east-1

jobs:
  terraform-import:
    name: ðŸ“¦ Import EBS CSI Driver to Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: ðŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c # v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: 1.5.0
      
      - name: ðŸ”‘ Get Account and OIDC Info
        id: info
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          OIDC_ID=$(aws eks describe-cluster \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'cluster.identity.oidc.issuer' \
            --output text | cut -d '/' -f 5)
          
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "oidc_id=$OIDC_ID" >> $GITHUB_OUTPUT
          
          echo "âœ… Account ID: $ACCOUNT_ID"
          echo "âœ… OIDC ID: $OIDC_ID"
      
      - name: ðŸ”„ Terraform Init
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          terraform init
      
      - name: ðŸ“¦ Import OIDC Provider
        working-directory: terraform/${{ github.event.inputs.environment }}
        continue-on-error: true
        run: |
          echo "ðŸ”‘ Importing OIDC Provider..."
          terraform import \
            "module.infrastructure.aws_iam_openid_connect_provider.eks[0]" \
            "arn:aws:iam::${{ steps.info.outputs.account_id }}:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/${{ steps.info.outputs.oidc_id }}" \
            || echo "âš ï¸ OIDC Provider already imported or doesn't exist"
      
      - name: ðŸ“¦ Import IAM Role
        working-directory: terraform/${{ github.event.inputs.environment }}
        continue-on-error: true
        run: |
          echo "ðŸ” Importing IAM Role..."
          terraform import \
            'module.infrastructure.aws_iam_role.ebs_csi_driver[0]' \
            tx01-eks-ebs-csi-driver \
            || echo "âš ï¸ IAM Role already imported or doesn't exist"
      
      - name: ðŸ“¦ Import IAM Policy Attachment
        working-directory: terraform/${{ github.event.inputs.environment }}
        continue-on-error: true
        run: |
          echo "ðŸ“‹ Importing IAM Policy Attachment..."
          terraform import \
            'module.infrastructure.aws_iam_role_policy_attachment.ebs_csi_driver_policy[0]' \
            tx01-eks-ebs-csi-driver/arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
            || echo "âš ï¸ Policy Attachment already imported or doesn't exist"
      
      - name: ðŸ“¦ Import EBS CSI Driver Addon
        working-directory: terraform/${{ github.event.inputs.environment }}
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Importing EBS CSI Driver addon..."
          terraform import \
            'module.infrastructure.aws_eks_addon.ebs_csi_driver[0]' \
            tx01-eks-${{ github.event.inputs.environment }}:aws-ebs-csi-driver \
            || echo "âš ï¸ EBS CSI Driver addon already imported or doesn't exist"
      
      - name: ðŸ” Debug - Check State Before Verify
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Current state resources:"
          terraform state list || echo "No resources in state yet"
          echo ""
          echo "ðŸ” Checking if imports were successful:"
          terraform state show 'module.infrastructure.aws_iam_openid_connect_provider.eks[0]' 2>&1 | head -n 5 || echo "OIDC not in state"
          terraform state show 'module.infrastructure.aws_iam_role.ebs_csi_driver[0]' 2>&1 | head -n 5 || echo "IAM Role not in state"
      
      - name: ðŸ” Verify Import
        working-directory: terraform/${{ github.event.inputs.environment }}
        continue-on-error: true
        run: |
          echo "ðŸ” Running terraform plan to verify..."
          terraform plan -no-color 2>&1 || echo "âš ï¸ Plan had issues, but continuing..."
      
      - name: ðŸ“Š Show State
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š All resources in state:"
          terraform state list
          echo ""
          echo "ðŸ“¦ EBS CSI and OIDC resources:"
          terraform state list | grep -E "ebs_csi|oidc" || echo "âš ï¸ No EBS CSI or OIDC resources found yet"
      
      - name: ðŸŽ¯ Summary
        run: |
          echo "## âœ… Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ github.event.inputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Imported:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OIDC Provider" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IAM Role (ebs-csi-driver)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IAM Policy Attachment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EBS CSI Driver Addon" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the Terraform plan output above" >> $GITHUB_STEP_SUMMARY
          echo "2. If everything looks good, resources are now managed by Terraform" >> $GITHUB_STEP_SUMMARY
          echo "3. Future changes should be made via Terraform" >> $GITHUB_STEP_SUMMARY
