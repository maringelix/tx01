name: ğŸ”„ Recreate EKS Node Group

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      instance_type:
        description: 'New Instance Type'
        required: true
        type: choice
        default: 't3.large'
        options:
          - t3.medium
          - t3.large
          - t3.xlarge
      confirm:
        description: 'Type RECREATE to confirm (will cause downtime)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  recreate-nodegroup:
    name: ğŸ”„ Recreate EKS Node Group
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RECREATE" ]; then
            echo "âŒ Confirmation failed. You must type exactly 'RECREATE'"
            exit 1
          fi
          echo "âœ… Confirmation validated"
      
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: ğŸ“Š Current Node Group Status
        run: |
          echo "ğŸ“Š Current EKS node group configuration:"
          aws eks describe-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'nodegroup.{InstanceType:instanceTypes[0],Status:status,DesiredSize:scalingConfig.desiredSize}' \
            --output table
      
      - name: ğŸ”„ Update Terraform Variables
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”„ Updating terraform.tfvars..."
          sed -i "s/eks_node_instance_type  = \".*\"/eks_node_instance_type  = \"${{ github.event.inputs.instance_type }}\"/" terraform.tfvars
          
          echo "âœ… Updated configuration:"
          grep "eks_node_instance_type" terraform.tfvars
      
      - name: ğŸ”§ Terraform Init
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: terraform init
      
      - name: ğŸ¯ Taint Node Group Resource
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ¯ Marking node group for recreation..."
          terraform taint 'module.infrastructure.aws_eks_node_group.main[0]' || true
          echo "âœ… Node group marked for recreation"
      
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ“‹ Planning node group recreation..."
          terraform plan -out=tfplan
          terraform show tfplan
      
      - name: â¸ï¸ Final Warning
        run: |
          echo "âš ï¸âš ï¸âš ï¸ WARNING âš ï¸âš ï¸âš ï¸"
          echo ""
          echo "This will DESTROY and RECREATE the EKS node group!"
          echo "There will be temporary downtime while pods are rescheduled."
          echo ""
          echo "â³ Waiting 15 seconds before proceeding..."
          
          for i in {15..1}; do
            echo -ne "   Continuing in $i seconds...\r"
            sleep 1
          done
          echo ""
          echo "ğŸš€ Proceeding with recreation..."
      
      - name: ğŸš€ Terraform Apply (Destroy + Create)
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸš€ Applying Terraform changes..."
          terraform apply -auto-approve tfplan
      
      - name: â³ Wait for New Node Group
        run: |
          echo "â³ Waiting for new node group to become ACTIVE..."
          
          MAX_WAIT=1200  # 20 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws eks describe-nodegroup \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
              --region ${{ env.AWS_REGION }} \
              --query 'nodegroup.status' \
              --output text)
            
            echo "Node group status: $STATUS (${ELAPSED}s elapsed)"
            
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "âœ… Node group is ACTIVE"
              break
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Timeout waiting for node group"
            exit 1
          fi
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
      
      - name: ğŸ” Verify New Nodes
        run: |
          echo "ğŸ” Verifying new nodes..."
          kubectl get nodes -o custom-columns=NAME:.metadata.name,STATUS:.status.conditions[-1].type,INSTANCE:.metadata.labels.'node\.kubernetes\.io/instance-type',AGE:.metadata.creationTimestamp
          
          echo ""
          echo "ğŸ“¦ Waiting for pods to stabilize..."
          sleep 60
          
          echo ""
          echo "ğŸ“Š Pod status:"
          kubectl get pods --all-namespaces | awk '{print $4}' | tail -n +2 | sort | uniq -c
      
      - name: ğŸ“Š Commit Updated Config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add terraform/${{ github.event.inputs.environment }}/terraform.tfvars
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: recreate EKS node group with ${{ github.event.inputs.instance_type }}"
            git push
          fi
      
      - name: ğŸ¯ Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… EKS NODE GROUP RECREATED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š New Configuration:"
          aws eks describe-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'nodegroup.{InstanceType:instanceTypes[0],DesiredSize:scalingConfig.desiredSize,Status:status}' \
            --output table
          
          echo ""
          echo "ğŸš€ Next steps:"
          echo "   â€¢ Wait a few minutes for all pods to stabilize"
          echo "   â€¢ Run: kubectl get pods --all-namespaces"
          echo "   â€¢ Deploy observability stack and Gatekeeper"
