name: ğŸ“Š Deploy Observability Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall
          - upgrade

env:
  AWS_REGION: us-east-1

jobs:
  deploy-grafana-stack:
    name: ğŸ“ˆ ${{ github.event.inputs.action }} Grafana Stack
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Kubectl configured"
          kubectl cluster-info
          kubectl get nodes
      
      - name: ğŸ¯ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: ğŸ“¦ Add Helm Repositories
        run: |
          echo "ğŸ“¦ Adding Helm repositories..."
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          echo "âœ… Repositories added and updated"
      
      - name: ğŸ“ Create Monitoring Namespace
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“ Creating monitoring namespace..."
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ready"
      
      - name: ğŸ” Validate Grafana Password Secret
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "ğŸ” Validating GRAFANA_PASSWORD secret..."
          
          if [ -z "${{ secrets.GRAFANA_PASSWORD }}" ]; then
            echo "âŒ ERROR: GRAFANA_PASSWORD secret is not configured!"
            echo ""
            echo "ğŸ“ To configure it:"
            echo "   1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: GRAFANA_PASSWORD"
            echo "   4. Value: <your-strong-password>"
            echo ""
            echo "âš ï¸  Use a strong password for production environments!"
            exit 1
          fi
          
          PASSWORD_LENGTH=$(echo -n "${{ secrets.GRAFANA_PASSWORD }}" | wc -c)
          if [ $PASSWORD_LENGTH -lt 8 ]; then
            echo "âš ï¸  WARNING: Password is too short (less than 8 characters)"
            echo "ğŸ“ Consider using a stronger password for production"
          fi
          
          echo "âœ… GRAFANA_PASSWORD secret is configured (length: $PASSWORD_LENGTH chars)"
          echo "ğŸ”’ Password will be securely applied to Grafana deployment"
      
      - name: ğŸ”Œ Ensure EBS CSI Driver is installed
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ” Checking EBS CSI Driver addon..."
          
          ADDON_STATUS=$(aws eks describe-addon \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --addon-name aws-ebs-csi-driver \
            --region ${{ env.AWS_REGION }} \
            --query 'addon.status' \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$ADDON_STATUS" = "NOT_FOUND" ]; then
            echo "âš ï¸  EBS CSI Driver not found, installing..."
            
            # Check if IAM role exists
            ROLE_EXISTS=$(aws iam get-role \
              --role-name tx01-eks-ebs-csi-driver \
              --query 'Role.RoleName' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$ROLE_EXISTS" = "NOT_FOUND" ]; then
              echo "Creating IAM role for EBS CSI Driver..."
              
              # Get OIDC provider
              OIDC_ID=$(aws eks describe-cluster \
                --name tx01-eks-${{ github.event.inputs.environment }} \
                --region ${{ env.AWS_REGION }} \
                --query 'cluster.identity.oidc.issuer' \
                --output text | cut -d '/' -f 5)
              
              ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
              
              # Create trust policy
              cat > trust-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": {
                "Federated": "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}"
              },
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                "StringEquals": {
                  "oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}:aud": "sts.amazonaws.com",
                  "oidc.eks.us-east-1.amazonaws.com/id/${OIDC_ID}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                }
              }
            }]
          }
          EOF
              
              # Create role
              aws iam create-role \
                --role-name tx01-eks-ebs-csi-driver \
                --assume-role-policy-document file://trust-policy.json
              
              # Attach policy
              aws iam attach-role-policy \
                --role-name tx01-eks-ebs-csi-driver \
                --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
              
              echo "âœ… IAM role created"
            else
              echo "âœ… IAM role already exists"
            fi
            
            # Install addon
            aws eks create-addon \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/tx01-eks-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            
            echo "â³ Waiting for addon to be ACTIVE..."
            aws eks wait addon-active \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… EBS CSI Driver installed"
          elif [ "$ADDON_STATUS" = "ACTIVE" ]; then
            echo "âœ… EBS CSI Driver already active"
          else
            echo "âš ï¸  EBS CSI Driver status: $ADDON_STATUS"
            echo "Waiting for it to become ACTIVE..."
            aws eks wait addon-active \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --addon-name aws-ebs-csi-driver \
              --region ${{ env.AWS_REGION }}
            echo "âœ… EBS CSI Driver is now active"
          fi
      
      - name: ğŸ“Š Install Prometheus + Grafana
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“Š Installing kube-prometheus-stack..."
          
          helm upgrade --install kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set prometheus.prometheusSpec.retention=7d \
            --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName=gp2 \
            --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi \
            --set grafana.adminPassword=${{ secrets.GRAFANA_PASSWORD }} \
            --set grafana.persistence.enabled=true \
            --set grafana.persistence.storageClassName=gp2 \
            --set grafana.persistence.size=5Gi \
            --set grafana.service.type=ClusterIP \
            --set alertmanager.enabled=true \
            --wait --timeout=10m
          
          echo "âœ… Prometheus + Grafana installed"
      
      - name: ğŸ“ Install Loki Stack
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“ Installing Loki stack..."
          
          helm upgrade --install loki grafana/loki-stack \
            --namespace monitoring \
            --set loki.persistence.enabled=true \
            --set loki.persistence.storageClassName=gp2 \
            --set loki.persistence.size=10Gi \
            --set promtail.enabled=true \
            --set grafana.enabled=false \
            --wait --timeout=5m
          
          echo "âœ… Loki stack installed"
      
      - name: ğŸ”” Apply Prometheus Alerts
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ”” Applying Prometheus alerts..."
          kubectl apply -f k8s/prometheus-alerts.yaml
          echo "âœ… Alerts configured"
      
      - name: ğŸ”„ Upgrade Stack
        if: github.event.inputs.action == 'upgrade'
        run: |
          echo "ğŸ”„ Upgrading observability stack..."
          
          helm upgrade kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --reuse-values \
            --wait --timeout=10m
          
          helm upgrade loki grafana/loki-stack \
            --namespace monitoring \
            --reuse-values \
            --wait --timeout=5m
          
          echo "âœ… Stack upgraded"
      
      - name: ğŸ—‘ï¸ Uninstall Stack
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "ğŸ—‘ï¸ Uninstalling observability stack..."
          
          helm uninstall kube-prometheus-stack -n monitoring || echo "Already uninstalled"
          helm uninstall loki -n monitoring || echo "Already uninstalled"
          
          echo "âš ï¸ Namespace 'monitoring' preserved (contains PVCs)"
          echo "To fully remove: kubectl delete namespace monitoring"
          
          echo "âœ… Stack uninstalled"
      
      - name: â³ Wait for Pods
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "â³ Waiting for pods to be ready..."
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=prometheus \
            -n monitoring \
            --timeout=300s || echo "Prometheus pods not ready yet"
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=grafana \
            -n monitoring \
            --timeout=300s || echo "Grafana pods not ready yet"
          
          echo "âœ… Pods are ready"
      
      - name: ğŸ“Š Get Grafana URL
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        id: grafana-url
        run: |
          echo "ğŸ“Š Getting Grafana URL..."
          
          # Wait for LoadBalancer to be ready
          sleep 30
          
          GRAFANA_URL=$(kubectl get svc -n monitoring kube-prometheus-stack-grafana \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
          
          if [ "$GRAFANA_URL" = "pending" ] || [ -z "$GRAFANA_URL" ]; then
            echo "âš ï¸ LoadBalancer URL not ready yet"
            echo "Run this command in a few minutes:"
            echo "kubectl get svc -n monitoring kube-prometheus-stack-grafana"
          else
            echo "ğŸŒ Grafana URL: http://$GRAFANA_URL"
            echo "grafana_url=$GRAFANA_URL" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ğŸ” Credentials:"
          echo "   Username: admin"
          echo "   Password: admin (or your GRAFANA_PASSWORD secret)"
          echo ""
          echo "ğŸ¯ Port-forward alternative:"
          echo "   kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80"
      
      - name: ğŸ“‹ Stack Status
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "ğŸ“‹ Observability Stack Status"
          echo "=============================="
          echo ""
          
          echo "ğŸ“¦ Helm Releases:"
          helm list -n monitoring
          
          echo ""
          echo "ğŸ¯ Pods:"
          kubectl get pods -n monitoring
          
          echo ""
          echo "ğŸ’¾ PersistentVolumeClaims:"
          kubectl get pvc -n monitoring
          
          echo ""
          echo "ğŸŒ Services:"
          kubectl get svc -n monitoring
      
      - name: ğŸ¯ Summary
        if: always()
        run: |
          echo "## ğŸ“Š Observability Stack Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ github.event.inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" = "install" ] || [ "${{ github.event.inputs.action }}" = "upgrade" ]; then
            echo "### ğŸ“Š Components Installed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Prometheus (metrics collection)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Grafana (dashboards)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Loki (log aggregation)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Promtail (log collection)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… AlertManager (alerting)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ” Access" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80" >> $GITHUB_STEP_SUMMARY
            echo "# http://localhost:3000 (admin/admin)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.action }}" = "uninstall" ]; then
            echo "### ğŸ—‘ï¸ Stack Removed" >> $GITHUB_STEP_SUMMARY
            echo "All monitoring components have been uninstalled." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** PVCs are preserved. To fully clean up:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "kubectl delete namespace monitoring" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
