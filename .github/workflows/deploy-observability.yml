name: ðŸ“Š Deploy Observability Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall
          - upgrade

env:
  AWS_REGION: us-east-1

jobs:
  deploy-grafana-stack:
    name: ðŸ“ˆ ${{ github.event.inputs.action }} Grafana Stack
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Kubectl configured"
          kubectl cluster-info
          kubectl get nodes
      
      - name: ðŸŽ¯ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: ðŸ“¦ Add Helm Repositories
        run: |
          echo "ðŸ“¦ Adding Helm repositories..."
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          echo "âœ… Repositories added and updated"
      
      - name: ðŸ“ Create Monitoring Namespace
        if: github.event.inputs.action == 'install'
        run: |
          echo "ðŸ“ Creating monitoring namespace..."
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ready"
      
      - name: ðŸ“Š Install Prometheus + Grafana
        if: github.event.inputs.action == 'install'
        run: |
          echo "ðŸ“Š Installing kube-prometheus-stack..."
          
          helm upgrade --install kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set prometheus.prometheusSpec.retention=7d \
            --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi \
            --set grafana.adminPassword=${{ secrets.GRAFANA_PASSWORD || 'admin' }} \
            --set grafana.persistence.enabled=true \
            --set grafana.persistence.size=5Gi \
            --set grafana.service.type=LoadBalancer \
            --set alertmanager.enabled=true \
            --wait --timeout=10m
          
          echo "âœ… Prometheus + Grafana installed"
      
      - name: ðŸ“ Install Loki Stack
        if: github.event.inputs.action == 'install'
        run: |
          echo "ðŸ“ Installing Loki stack..."
          
          helm upgrade --install loki grafana/loki-stack \
            --namespace monitoring \
            --set loki.persistence.enabled=true \
            --set loki.persistence.size=10Gi \
            --set promtail.enabled=true \
            --set grafana.enabled=false \
            --wait --timeout=5m
          
          echo "âœ… Loki stack installed"
      
      - name: ðŸ”” Apply Prometheus Alerts
        if: github.event.inputs.action == 'install'
        run: |
          echo "ðŸ”” Applying Prometheus alerts..."
          kubectl apply -f k8s/prometheus-alerts.yaml
          echo "âœ… Alerts configured"
      
      - name: ðŸ”„ Upgrade Stack
        if: github.event.inputs.action == 'upgrade'
        run: |
          echo "ðŸ”„ Upgrading observability stack..."
          
          helm upgrade kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --reuse-values \
            --wait --timeout=10m
          
          helm upgrade loki grafana/loki-stack \
            --namespace monitoring \
            --reuse-values \
            --wait --timeout=5m
          
          echo "âœ… Stack upgraded"
      
      - name: ðŸ—‘ï¸ Uninstall Stack
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "ðŸ—‘ï¸ Uninstalling observability stack..."
          
          helm uninstall kube-prometheus-stack -n monitoring || echo "Already uninstalled"
          helm uninstall loki -n monitoring || echo "Already uninstalled"
          
          echo "âš ï¸ Namespace 'monitoring' preserved (contains PVCs)"
          echo "To fully remove: kubectl delete namespace monitoring"
          
          echo "âœ… Stack uninstalled"
      
      - name: â³ Wait for Pods
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "â³ Waiting for pods to be ready..."
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=prometheus \
            -n monitoring \
            --timeout=300s || echo "Prometheus pods not ready yet"
          
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=grafana \
            -n monitoring \
            --timeout=300s || echo "Grafana pods not ready yet"
          
          echo "âœ… Pods are ready"
      
      - name: ðŸ“Š Get Grafana URL
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        id: grafana-url
        run: |
          echo "ðŸ“Š Getting Grafana URL..."
          
          # Wait for LoadBalancer to be ready
          sleep 30
          
          GRAFANA_URL=$(kubectl get svc -n monitoring kube-prometheus-stack-grafana \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
          
          if [ "$GRAFANA_URL" = "pending" ] || [ -z "$GRAFANA_URL" ]; then
            echo "âš ï¸ LoadBalancer URL not ready yet"
            echo "Run this command in a few minutes:"
            echo "kubectl get svc -n monitoring kube-prometheus-stack-grafana"
          else
            echo "ðŸŒ Grafana URL: http://$GRAFANA_URL"
            echo "grafana_url=$GRAFANA_URL" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ðŸ” Credentials:"
          echo "   Username: admin"
          echo "   Password: admin (or your GRAFANA_PASSWORD secret)"
          echo ""
          echo "ðŸŽ¯ Port-forward alternative:"
          echo "   kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80"
      
      - name: ðŸ“‹ Stack Status
        if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
        run: |
          echo "ðŸ“‹ Observability Stack Status"
          echo "=============================="
          echo ""
          
          echo "ðŸ“¦ Helm Releases:"
          helm list -n monitoring
          
          echo ""
          echo "ðŸŽ¯ Pods:"
          kubectl get pods -n monitoring
          
          echo ""
          echo "ðŸ’¾ PersistentVolumeClaims:"
          kubectl get pvc -n monitoring
          
          echo ""
          echo "ðŸŒ Services:"
          kubectl get svc -n monitoring
      
      - name: ðŸŽ¯ Summary
        if: always()
        run: |
          echo "## ðŸ“Š Observability Stack Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ github.event.inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" = "install" ] || [ "${{ github.event.inputs.action }}" = "upgrade" ]; then
            echo "### ðŸ“Š Components Installed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Prometheus (metrics collection)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Grafana (dashboards)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Loki (log aggregation)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Promtail (log collection)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… AlertManager (alerting)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Access" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80" >> $GITHUB_STEP_SUMMARY
            echo "# http://localhost:3000 (admin/admin)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.action }}" = "uninstall" ]; then
            echo "### ðŸ—‘ï¸ Stack Removed" >> $GITHUB_STEP_SUMMARY
            echo "All monitoring components have been uninstalled." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** PVCs are preserved. To fully clean up:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "kubectl delete namespace monitoring" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
