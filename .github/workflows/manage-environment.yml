name: âš¡ Manage Environment (EKS + RDS)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - shutdown  # Desliga EKS + RDS
          - startup   # Liga EKS + RDS
          - status    # Verifica status
      environment:
        description: 'Environment'
        required: true
        default: 'stg'
        type: choice
        options:
          - stg
          - prd

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: tx01-eks-${{ inputs.environment }}

jobs:
  manage-rds:
    name: ${{ inputs.action }} RDS Database
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Get RDS Instance
        id: get-rds
        run: |
          RDS_ID=$(aws rds describe-db-instances \
            --query "DBInstances[?contains(DBInstanceIdentifier, 'tx01-${{ inputs.environment }}')].DBInstanceIdentifier" \
            --output text | head -1)
          
          if [ -z "$RDS_ID" ]; then
            echo "âš ï¸ No RDS instance found for environment: ${{ inputs.environment }}"
            echo "rds_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "rds_id=$RDS_ID" >> $GITHUB_OUTPUT
          echo "rds_found=true" >> $GITHUB_OUTPUT
          echo "âœ… Found RDS: $RDS_ID"
          
          # Get current status
          STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier $RDS_ID \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text)
          
          echo "current_status=$STATUS" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Current status: $STATUS"

      - name: â¸ï¸ Stop RDS Database
        if: inputs.action == 'shutdown' && steps.get-rds.outputs.rds_found == 'true' && steps.get-rds.outputs.current_status == 'available'
        run: |
          echo "Stopping RDS: ${{ steps.get-rds.outputs.rds_id }}"
          aws rds stop-db-instance --db-instance-identifier ${{ steps.get-rds.outputs.rds_id }}
          echo "âœ… RDS stop initiated"
          echo "âš ï¸ Note: RDS will auto-restart after 7 days"

      - name: â–¶ï¸ Start RDS Database
        if: inputs.action == 'startup' && steps.get-rds.outputs.rds_found == 'true' && steps.get-rds.outputs.current_status == 'stopped'
        run: |
          echo "Starting RDS: ${{ steps.get-rds.outputs.rds_id }}"
          aws rds start-db-instance --db-instance-identifier ${{ steps.get-rds.outputs.rds_id }}
          echo "âœ… RDS start initiated (takes ~5 minutes)"

      - name: ðŸ“Š RDS Status
        if: steps.get-rds.outputs.rds_found == 'true'
        run: |
          RDS_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier ${{ steps.get-rds.outputs.rds_id }} \
            --query 'DBInstances[0].[DBInstanceIdentifier,DBInstanceClass,DBInstanceStatus,Engine,AllocatedStorage]' \
            --output text)
          
          echo "## ðŸ—„ï¸ RDS Database Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.get-rds.outputs.current_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$RDS_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  manage-eks:
    name: ${{ inputs.action }} EKS Cluster
    runs-on: ubuntu-latest
    needs: manage-rds
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: ðŸ” Check EKS Cluster
        id: check-eks
        run: |
          if aws eks describe-cluster --name ${{ env.CLUSTER_NAME }} 2>/dev/null; then
            echo "eks_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… EKS cluster exists: ${{ env.CLUSTER_NAME }}"
          else
            echo "eks_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ EKS cluster not found: ${{ env.CLUSTER_NAME }}"
          fi

      - name: â¸ï¸ Shutdown EKS Cluster
        if: inputs.action == 'shutdown' && steps.check-eks.outputs.eks_exists == 'true'
        run: |
          cd terraform/${{ inputs.environment }}
          
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
          
          echo "â¸ï¸ Destroying EKS cluster (keeping VPC, RDS, etc)..."
          terraform destroy \
            -target='module.infrastructure.module.eks[0].aws_eks_cluster.main' \
            -target='module.infrastructure.module.eks[0].aws_eks_node_group.main' \
            -target='module.infrastructure.module.eks[0].aws_iam_role.eks_cluster' \
            -target='module.infrastructure.module.eks[0].aws_iam_role.eks_nodes' \
            -auto-approve
          
          echo "âœ… EKS cluster destroyed successfully"
          echo "ðŸ’° Saving ~\$133/month"

      - name: â–¶ï¸ Start EKS Cluster  
        if: inputs.action == 'startup' && steps.check-eks.outputs.eks_exists == 'false'
        run: |
          cd terraform/${{ inputs.environment }}
          
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
          
          echo "â–¶ï¸ Creating EKS cluster..."
          terraform apply -auto-approve
          
          echo "âœ… EKS cluster created successfully"
          
          # Configure kubectl
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          
          echo "ðŸ“¦ Redeploying application..."
          kubectl apply -f ../../k8s/
          
          echo "â³ Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=dx01-app --timeout=300s || true
          
          echo "âœ… Application redeployed"

      - name: ðŸ“Š Environment Status
        if: inputs.action == 'status'
        run: |
          echo "## ðŸ“Š Environment Status: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # EKS Status
          if [ "${{ steps.check-eks.outputs.eks_exists }}" == "true" ]; then
            echo "### â˜¸ï¸ EKS Cluster: **RUNNING** âœ…" >> $GITHUB_STEP_SUMMARY
            
            aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null || true
            
            NODE_COUNT=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")
            POD_COUNT=$(kubectl get pods --all-namespaces --no-headers 2>/dev/null | wc -l || echo "0")
            
            echo "- **Nodes:** $NODE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Pods:** $POD_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â˜¸ï¸ EKS Cluster: **STOPPED** ðŸ’¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’° Cost Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’° Monthly Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Running | Stopped |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **EKS Control Plane** | \$73.00 | \$0.00 |" >> $GITHUB_STEP_SUMMARY
          echo "| **4Ã— t3.small nodes** | \$60.16 | \$0.00 |" >> $GITHUB_STEP_SUMMARY
          echo "| **RDS t4g.micro** | \$12.41 | \$0.00 |" >> $GITHUB_STEP_SUMMARY
          echo "| **RDS Storage (20GB)** | \$2.30 | \$2.30 |" >> $GITHUB_STEP_SUMMARY
          echo "| **NAT Gateways (2Ã—)** | \$65.70 | \$65.70 âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| **EBS Volumes** | \$4.40 | \$0.00 |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 + ECR** | \$0.30 | \$0.30 |" >> $GITHUB_STEP_SUMMARY
          echo "| **â”â”â”â”â”â”â”â”â”â”â”â”** | **â”â”â”â”â”â”â”â”** | **â”â”â”â”â”â”â”â”** |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOTAL** | **\$218.27/mÃªs** | **\$68.30/mÃªs** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.action }}" == "shutdown" ]; then
            echo "âœ… **Savings:** ~\$150/mÃªs with EKS + RDS stopped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â° **Your \$92 credit will last:** ~40 days" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.action }}" == "startup" ]; then
            echo "âš ï¸ **Monthly cost:** ~\$218/mÃªs with everything running" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â° **Your \$92 credit will last:** ~12 days" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** NAT Gateways cannot be stopped and cost \$65.70/mÃªs" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”— Application URL
        if: inputs.action == 'startup' || (inputs.action == 'status' && steps.check-eks.outputs.eks_exists == 'true')
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null || true
          
          INGRESS_URL=$(kubectl get ingress tx01-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "Not ready yet")
          
          if [ "$INGRESS_URL" != "Not ready yet" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ”— Application URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** http://$INGRESS_URL" >> $GITHUB_STEP_SUMMARY
          fi
