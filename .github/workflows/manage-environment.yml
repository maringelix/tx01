name: âš¡ Manage Environment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - start
          - stop
          - status
      environment:
        description: 'Environment'
        required: true
        default: 'stg'
        type: choice
        options:
          - stg
          - prd

env:
  AWS_REGION: us-east-1

jobs:
  manage-ec2:
    name: ${{ inputs.action }} EC2 Instances
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Get EC2 Instance IDs
        id: get-instances
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=tx01-ec2-*-${{ inputs.environment }}" \
                      "Name=instance-state-name,Values=running,stopped" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)
          
          if [ -z "$INSTANCE_IDS" ]; then
            echo "âš ï¸ No EC2 instances found for environment: ${{ inputs.environment }}"
            exit 0
          fi
          
          echo "instances=$INSTANCE_IDS" >> $GITHUB_OUTPUT
          echo "âœ… Found instances: $INSTANCE_IDS"

      - name: ðŸ—„ï¸ RDS ${{ inputs.action }}
        if: inputs.action == 'start' || inputs.action == 'stop' || inputs.action == 'status'
        env:
          ENV: ${{ inputs.environment }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -e
          DB_ID="tx01-db-${ENV}"
          echo "Managing RDS instance: $DB_ID"

          if [ "${{ inputs.action }}" = "start" ]; then
            echo "Starting RDS..."
            aws rds start-db-instance --db-instance-identifier "$DB_ID" --region "$AWS_REGION" >/dev/null 2>&1 || true
            echo "Waiting for RDS to become 'available'..."
            END=$(( $(date +%s) + 900 ))
            while [ $(date +%s) -lt $END ]; do
              ST=$(aws rds describe-db-instances --db-instance-identifier "$DB_ID" --region "$AWS_REGION" --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null || echo unknown)
              echo "RDS status: $ST"
              [ "$ST" = "available" ] && break
              sleep 20
            done
          elif [ "${{ inputs.action }}" = "stop" ]; then
            echo "Stopping RDS..."
            aws rds stop-db-instance --db-instance-identifier "$DB_ID" --region "$AWS_REGION" >/dev/null 2>&1 || true
            echo "Waiting for RDS to become 'stopped'..."
            END=$(( $(date +%s) + 900 ))
            while [ $(date +%s) -lt $END ]; do
              ST=$(aws rds describe-db-instances --db-instance-identifier "$DB_ID" --region "$AWS_REGION" --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null || echo unknown)
              echo "RDS status: $ST"
              [ "$ST" = "stopped" ] && break
              sleep 20
            done
          fi

          CURRENT=$(aws rds describe-db-instances --db-instance-identifier "$DB_ID" --region "$AWS_REGION" --query 'DBInstances[0].{Status:DBInstanceStatus,Endpoint:Endpoint.Address,Class:DBInstanceClass,Engine:Engine}' --output json 2>/dev/null || echo '{}')
          {
            echo "## ðŸ—„ï¸ RDS (${ENV})";
            echo "```${CURRENT}```";
          } >> $GITHUB_STEP_SUMMARY

      - name: â–¶ï¸ Start EC2 (power on)
        if: inputs.action == 'start' && steps.get-instances.outputs.instances != ''
        run: |
          echo "Starting EC2 instances: ${{ steps.get-instances.outputs.instances }}"
          aws ec2 start-instances --instance-ids ${{ steps.get-instances.outputs.instances }} --region ${{ env.AWS_REGION }} >/dev/null
          echo "Waiting for instances to be running..."
          aws ec2 wait instance-running --instance-ids ${{ steps.get-instances.outputs.instances }} --region ${{ env.AWS_REGION }}

      - name: ðŸ” Register EC2 in Target Group
        if: inputs.action == 'start' && steps.get-instances.outputs.instances != ''
        run: |
          set -e
          echo "Registering instances to ALB target group (robust flow)..."
          TG_NAME="tx01-tg-${{ inputs.environment }}"
          TG_ARN=$(aws elbv2 describe-target-groups --names "$TG_NAME" --region ${{ env.AWS_REGION }} --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || true)
          if [ -z "$TG_ARN" ] || [ "$TG_ARN" = "None" ]; then
            echo "Target group $TG_NAME not found by name. Searching by environment..."
            TG_ARN=$(aws elbv2 describe-target-groups --region ${{ env.AWS_REGION }} --query "TargetGroups[?contains(@.TargetGroupName, '${{ inputs.environment }}')].TargetGroupArn | [0]" --output text 2>/dev/null || true)
          fi

          if [ -z "$TG_ARN" ] || [ "$TG_ARN" = "None" ]; then
            echo "âš ï¸ Could not find target group ARN for environment: ${{ inputs.environment }}"
            exit 0
          fi

          echo "Found Target Group ARN: $TG_ARN"

          # Show current targets
          echo "Current targets before change:"
          aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region ${{ env.AWS_REGION }} --output table || true

          # Attempt to deregister any existing targets for a clean replacement
          EXISTING_IDS=$(aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region ${{ env.AWS_REGION }} --query 'TargetHealthDescriptions[].Target.Id' --output text || true)
          if [ -n "$EXISTING_IDS" ]; then
            echo "Deregistering existing targets: $EXISTING_IDS"
            for old in $EXISTING_IDS; do
              aws elbv2 deregister-targets --target-group-arn "$TG_ARN" --targets Id=$old --region ${{ env.AWS_REGION }} || echo "warn: failed to deregister $old"
            done
          fi

          # Register desired instances
          echo "Registering new instances: ${{ steps.get-instances.outputs.instances }}"
          for id in ${{ steps.get-instances.outputs.instances }}; do
            echo "Registering instance $id"
            aws elbv2 register-targets --target-group-arn "$TG_ARN" --targets Id=$id --region ${{ env.AWS_REGION }} || echo "warn: failed to register $id"
          done

          # Wait for targets to become healthy (timeout 180s)
          echo "Waiting for targets to become healthy (timeout 180s)"
          DEADLINE=$(( $(date +%s) + 180 ))
          while [ $(date +%s) -lt $DEADLINE ]; do
            STATES=$(aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region ${{ env.AWS_REGION }} --query 'TargetHealthDescriptions[].TargetHealth.State' --output text || true)
            echo "Current states: $STATES"
            if [ -n "$STATES" ]; then
              all_healthy=true
              for s in $STATES; do
                if [ "$s" != "healthy" ]; then
                  all_healthy=false
                  break
                fi
              done
              if [ "$all_healthy" = true ]; then
                echo "âœ… All targets healthy"
                break
              fi
            fi
            sleep 10
          done

          echo "Final target health:" 
          aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region ${{ env.AWS_REGION }} --output table || true
          echo "" >> $GITHUB_STEP_SUMMARY
          
          aws ec2 describe-instances \
            --instance-ids ${{ steps.get-instances.outputs.instances }} \
            --query 'Reservations[].Instances[].[Tags[?Key==`Name`].Value|[0],InstanceId,InstanceType,State.Name,PublicIpAddress]' \
            --output table >> $GITHUB_STEP_SUMMARY

      - name: â¹ï¸ Stop EC2 Instances
        if: inputs.action == 'stop' && steps.get-instances.outputs.instances != ''
        run: |
          set -e
          echo "Deregistering instances from ALB target group and stopping EC2..."
          TG_NAME="tx01-tg-${{ inputs.environment }}"
          TG_ARN=$(aws elbv2 describe-target-groups --names "$TG_NAME" --region ${{ env.AWS_REGION }} --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || true)
          if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
            for id in ${{ steps.get-instances.outputs.instances }}; do
              aws elbv2 deregister-targets --target-group-arn "$TG_ARN" --targets Id=$id --region ${{ env.AWS_REGION }} || true
            done
          fi
          aws ec2 stop-instances --instance-ids ${{ steps.get-instances.outputs.instances }} --region ${{ env.AWS_REGION }} >/dev/null || true
          echo "Waiting for instances to stop..."
          aws ec2 wait instance-stopped --instance-ids ${{ steps.get-instances.outputs.instances }} --region ${{ env.AWS_REGION }} || true
          echo "EC2 stopped."

      - name: ðŸ’° Cost Estimate
        if: inputs.action == 'status' || inputs.action == 'start' || inputs.action == 'stop'
        run: |
          INSTANCE_COUNT=$(echo "${{ steps.get-instances.outputs.instances }}" | wc -w)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’° Monthly Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Running | Stopped |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **$INSTANCE_COUNTÃ— t2.micro** | ~\$17/mÃªs | \$0 |" >> $GITHUB_STEP_SUMMARY
          echo "| **ALB** | ~\$20/mÃªs | ~\$20/mÃªs âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| **EBS (16GB)** | \$1.28/mÃªs | \$1.28/mÃªs |" >> $GITHUB_STEP_SUMMARY
          echo "| **ECR + S3** | \$0.10/mÃªs | \$0.10/mÃªs |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOTAL** | **~\$38/mÃªs** | **~\$21/mÃªs** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** ALB continues charging even with stopped EC2 instances." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.action }}" == "stop" ]; then
            echo "âœ… **Savings:** ~\$17/mÃªs with EC2 stopped" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”— Get ALB URL
        if: inputs.action == 'start'
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names "tx01-alb-${{ inputs.environment }}" \
            --query 'LoadBalancers[0].DNSName' \
            --output text 2>/dev/null || echo "Not found")
          
          if [ "$ALB_DNS" != "Not found" ] && [ "$ALB_DNS" != "None" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ”— Application URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ALB:** http://$ALB_DNS" >> $GITHUB_STEP_SUMMARY
          fi
