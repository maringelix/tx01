name: ğŸ’¥ Destroy and Recreate Node Group

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      new_instance_type:
        description: 'New Instance Type'
        required: true
        type: choice
        default: 't3.large'
        options:
          - t3.medium
          - t3.large
          - t3.xlarge
      confirm:
        description: 'Type DESTROY to confirm (will cause downtime)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0

jobs:
  destroy-and-recreate:
    name: ğŸ’¥ Destroy and Recreate Node Group
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DESTROY" ]; then
            echo "âŒ Confirmation failed. You must type exactly 'DESTROY'"
            exit 1
          fi
          echo "âœ… Confirmation validated"
      
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c # v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ“Š Current Node Group Status
        run: |
          echo "ğŸ“Š Current configuration:"
          aws eks describe-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'nodegroup.{InstanceType:instanceTypes[0],Status:status,DesiredSize:scalingConfig.desiredSize}' \
            --output table
      
      - name: ğŸ’¥ Delete Node Group via AWS CLI
        run: |
          echo "ğŸ’¥ Deleting node group tx01-ng-${{ github.event.inputs.environment }}..."
          aws eks delete-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Delete command sent"
      
      - name: â³ Wait for Node Group Deletion
        run: |
          echo "â³ Waiting for node group to be deleted..."
          
          MAX_WAIT=1200  # 20 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            set +e
            STATUS=$(aws eks describe-nodegroup \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
              --region ${{ env.AWS_REGION }} \
              --query 'nodegroup.status' \
              --output text 2>&1)
            EXIT_CODE=$?
            set -e
            
            if [ $EXIT_CODE -ne 0 ]; then
              if echo "$STATUS" | grep -q "ResourceNotFoundException"; then
                echo "âœ… Node group successfully deleted"
                break
              fi
            fi
            
            echo "Node group status: $STATUS (${ELAPSED}s elapsed)"
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Timeout waiting for deletion"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: ğŸ”„ Update Terraform Variables
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”„ Updating terraform.tfvars..."
          sed -i "s/eks_node_instance_type  = \".*\"/eks_node_instance_type  = \"${{ github.event.inputs.new_instance_type }}\"/" terraform.tfvars
          
          echo "âœ… Updated configuration:"
          grep "eks_node_instance_type" terraform.tfvars
      
      - name: ğŸ”§ Terraform Init
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: terraform init
      
      - name: ğŸ”„ Refresh Terraform State
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”„ Refreshing Terraform state..."
          terraform refresh
      
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ“‹ Planning new node group creation..."
          terraform plan -out=tfplan
      
      - name: ğŸš€ Terraform Apply (Create New Node Group)
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸš€ Creating new node group with ${{ github.event.inputs.new_instance_type }}..."
          terraform apply -auto-approve tfplan
      
      - name: â³ Wait for New Node Group to be Active
        run: |
          echo "â³ Waiting for new node group to become ACTIVE..."
          
          MAX_WAIT=1200  # 20 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws eks describe-nodegroup \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
              --region ${{ env.AWS_REGION }} \
              --query 'nodegroup.status' \
              --output text)
            
            echo "Node group status: $STATUS (${ELAPSED}s elapsed)"
            
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "âœ… Node group is ACTIVE"
              break
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Timeout waiting for node group to become ACTIVE"
            exit 1
          fi
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
      
      - name: ğŸ” Verify New Nodes
        run: |
          echo "ğŸ” Verifying new nodes..."
          kubectl get nodes -o custom-columns=NAME:.metadata.name,STATUS:.status.conditions[-1].type,INSTANCE:.metadata.labels.'node\.kubernetes\.io/instance-type',AGE:.metadata.creationTimestamp
          
          echo ""
          echo "ğŸ“¦ Waiting 90 seconds for pods to stabilize..."
          sleep 90
          
          echo ""
          echo "ğŸ“Š Pod status across all namespaces:"
          kubectl get pods --all-namespaces -o wide
      
      - name: ğŸ”§ Scale Up Critical Workloads
        run: |
          echo "ğŸ”§ Ensuring critical workloads are running..."
          
          # Check if tx01-app deployment exists and scale if needed
          if kubectl get deployment tx01-app -n default &> /dev/null; then
            echo "Scaling tx01-app to 2 replicas..."
            kubectl scale deployment tx01-app -n default --replicas=2
          fi
          
          # Check Gatekeeper
          if kubectl get namespace gatekeeper-system &> /dev/null; then
            echo "Scaling Gatekeeper..."
            kubectl scale deployment gatekeeper-controller-manager -n gatekeeper-system --replicas=1 || true
            kubectl scale deployment gatekeeper-audit -n gatekeeper-system --replicas=1 || true
          fi
      
      - name: ğŸ“Š Commit Updated Config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add terraform/${{ github.event.inputs.environment }}/terraform.tfvars
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: upgrade EKS nodes to ${{ github.event.inputs.new_instance_type }} [skip ci]"
            git push
          fi
      
      - name: ğŸ¯ Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… NODE GROUP RECREATED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š New Configuration:"
          aws eks describe-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'nodegroup.{InstanceType:instanceTypes[0],DesiredSize:scalingConfig.desiredSize,Status:status}' \
            --output table
          
          echo ""
          echo "ğŸš€ Application should be back online!"
          echo "   Verify: kubectl get pods -n default"
          echo "   Next: Deploy observability stack and Gatekeeper"
