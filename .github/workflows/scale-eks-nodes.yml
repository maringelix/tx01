name: ğŸ”§ Scale EKS Nodes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stg
          - prd
      instance_type:
        description: 'Node Instance Type'
        required: true
        type: choice
        default: 't3.large'
        options:
          - t3.medium
          - t3.large
          - t3.xlarge
      desired_size:
        description: 'Desired Number of Nodes'
        required: true
        type: number
        default: 2

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  scale-eks-nodes:
    name: ğŸ”§ Scale EKS Nodes to ${{ github.event.inputs.instance_type }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: ğŸ“Š Current EKS Node Group Status
        run: |
          echo "ğŸ“Š Checking current EKS node group configuration..."
          aws eks describe-nodegroup \
            --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
            --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --query 'nodegroup.{InstanceType:instanceTypes[0],DesiredSize:scalingConfig.desiredSize,MinSize:scalingConfig.minSize,MaxSize:scalingConfig.maxSize}' \
            --output table
      
      - name: ğŸ”„ Update Terraform Variables
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”„ Updating terraform.tfvars with new configuration..."
          
          # Update instance type
          sed -i "s/eks_node_instance_type  = \".*\"/eks_node_instance_type  = \"${{ github.event.inputs.instance_type }}\"/" terraform.tfvars
          
          # Update desired size
          sed -i "s/eks_node_desired_size   = .*/eks_node_desired_size   = ${{ github.event.inputs.desired_size }}/" terraform.tfvars
          
          echo "âœ… terraform.tfvars updated:"
          grep -E "(eks_node_instance_type|eks_node_desired_size)" terraform.tfvars
      
      - name: ğŸ”§ Terraform Init
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init
      
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ“‹ Planning Terraform changes..."
          terraform plan -out=tfplan
      
      - name: ğŸš€ Terraform Apply
        working-directory: terraform/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸš€ Applying Terraform changes to scale EKS nodes..."
          terraform apply -auto-approve tfplan
      
      - name: â³ Wait for Node Group Update
        run: |
          echo "â³ Waiting for node group to update..."
          
          MAX_WAIT=900  # 15 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws eks describe-nodegroup \
              --cluster-name tx01-eks-${{ github.event.inputs.environment }} \
              --nodegroup-name tx01-ng-${{ github.event.inputs.environment }} \
              --region ${{ env.AWS_REGION }} \
              --query 'nodegroup.status' \
              --output text)
            
            echo "Node group status: $STATUS (${ELAPSED}s elapsed)"
            
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "âœ… Node group is ACTIVE"
              break
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Timeout waiting for node group to become ACTIVE"
            exit 1
          fi
      
      - name: â˜¸ï¸ Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name tx01-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}
      
      - name: ğŸ” Verify New Nodes
        run: |
          echo "ğŸ” Verifying new nodes are ready..."
          kubectl get nodes -o wide
          
          echo ""
          echo "ğŸ“Š Node resources:"
          kubectl top nodes || echo "âš ï¸ Metrics server not available yet"
          
          echo ""
          echo "ğŸ“¦ Pods distribution:"
          kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
      
      - name: ğŸ§¹ Clean Old Pending Pods
        run: |
          echo "ğŸ§¹ Cleaning up old pending pods..."
          
          # Delete pending pods older than 5 minutes
          kubectl get pods --all-namespaces --field-selector status.phase=Pending -o json | \
            jq -r '.items[] | select(.metadata.creationTimestamp | fromdateiso8601 < (now - 300)) | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read ns pod; do
              echo "Deleting pending pod: $ns/$pod"
              kubectl delete pod $pod -n $ns --force --grace-period=0 || true
            done
          
          echo ""
          echo "âœ… Cleanup completed"
      
      - name: ğŸ“Š Commit Updated terraform.tfvars
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add terraform/${{ github.event.inputs.environment }}/terraform.tfvars
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: scale EKS nodes to ${{ github.event.inputs.instance_type }} (desired: ${{ github.event.inputs.desired_size }})"
            git push
          fi
      
      - name: ğŸ¯ Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… EKS NODES SCALED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š New Configuration:"
          echo "   Instance Type: ${{ github.event.inputs.instance_type }}"
          echo "   Desired Nodes: ${{ github.event.inputs.desired_size }}"
          echo ""
          echo "ğŸ” Verify nodes:"
          echo "   kubectl get nodes -o wide"
          echo ""
          echo "ğŸ“¦ Check pod status:"
          echo "   kubectl get pods --all-namespaces"
          echo ""
          echo "ğŸ’¡ Next steps:"
          echo "   â€¢ Pods should now have enough resources"
          echo "   â€¢ Pending pods will be scheduled automatically"
          echo "   â€¢ You can now redeploy Gatekeeper and observability stack"
